<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü•ó Macmimi Diet Tracker</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:system-ui,-apple-system,sans-serif; background:#1a1a2e; color:#eee; min-height:100vh; padding:16px; }
  .container { max-width:480px; margin:0 auto; }
  h1 { text-align:center; font-size:1.5em; margin-bottom:8px; }
  .subtitle { text-align:center; color:#888; font-size:0.85em; margin-bottom:20px; }
  .card { background:#16213e; border-radius:16px; padding:16px; margin-bottom:12px; }
  .card h2 { font-size:1.1em; margin-bottom:10px; color:#00d4aa; }
  .highlight { color:#00d4aa; font-weight:bold; }
  .row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; }
  .row.border { border-bottom:1px solid #ffffff10; }
  .macro-bar { display:flex; gap:8px; margin-top:8px; }
  .macro { flex:1; text-align:center; background:#0f3460; border-radius:10px; padding:8px 4px; }
  .macro .val { font-size:1.2em; font-weight:bold; color:#00d4aa; }
  .macro .lbl { font-size:0.7em; color:#888; margin-top:2px; }
  .progress-bg { background:#0f3460; border-radius:10px; height:12px; overflow:hidden; margin-top:6px; }
  .progress-fill { height:100%; border-radius:10px; transition:width 0.5s ease; }
  .green { background:linear-gradient(90deg,#00d4aa,#00b894); }
  .blue { background:linear-gradient(90deg,#0984e3,#74b9ff); }
  .meal { padding:10px 0; border-bottom:1px solid #ffffff10; }
  .meal:last-child { border:none; }
  .meal-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
  .meal-header label { display:flex; align-items:center; gap:8px; cursor:pointer; flex:1; }
  .meal-header .cal { color:#00d4aa; font-weight:bold; font-size:0.9em; }
  .meal-details { display:none; margin-top:8px; padding-left:28px; }
  .meal-details.open { display:block; }
  .meal-details li { color:#aaa; font-size:0.8em; padding:2px 0; list-style:none; }
  .meal-details li span { color:#00d4aa; }
  input[type=checkbox] { width:18px; height:18px; accent-color:#00d4aa; }
  input[type=number], input[type=text] { background:#0f3460; border:1px solid #ffffff20; color:#eee; padding:8px 12px; border-radius:10px; width:100%; font-size:1em; }
  button { background:#00d4aa; color:#1a1a2e; border:none; padding:10px 20px; border-radius:10px; font-weight:bold; cursor:pointer; font-size:0.9em; }
  button:active { transform:scale(0.97); }
  .water-row { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
  .water-btn { width:36px; height:36px; border-radius:50%; border:2px solid #0984e3; background:transparent; color:#0984e3; font-size:1.2em; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
  .water-btn.filled { background:#0984e3; color:#fff; }
  .weight-chart { width:100%; height:150px; margin-top:10px; }
  .stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .stat { text-align:center; background:#0f3460; border-radius:10px; padding:10px; }
  .stat .val { font-size:1.4em; font-weight:bold; color:#00d4aa; }
  .stat .lbl { font-size:0.7em; color:#888; }
  .eaten .meal-header label { text-decoration:line-through; color:#666; }
  .eaten .cal { color:#666 !important; }
  canvas { width:100%; height:150px; }
  .tag { display:inline-block; background:#00d4aa20; color:#00d4aa; padding:2px 10px; border-radius:20px; font-size:0.8em; }

  /* === Meal check-off animations === */
  @keyframes greenFlash {
    0% { background-color: transparent; }
    30% { background-color: #00d4aa30; }
    100% { background-color: transparent; }
  }
  .meal.flash-green { animation: greenFlash 0.6s ease-out; }
  .meal .meal-header label {
    transition: color 0.3s ease, text-decoration-color 0.3s ease;
  }
  .meal.eaten .meal-header label {
    text-decoration: line-through;
    text-decoration-color: #666;
  }
  .meal .cal { transition: color 0.3s ease; }

  /* === Modal styles === */
  .modal-overlay {
    display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6);
    z-index:1000; align-items:center; justify-content:center;
  }
  .modal-overlay.open { display:flex; }
  .modal {
    background:#16213e; border-radius:16px; padding:24px; width:90%; max-width:400px;
    box-shadow:0 8px 32px rgba(0,0,0,0.5);
    animation: modalIn 0.25s ease-out;
  }
  @keyframes modalIn {
    from { opacity:0; transform:translateY(20px) scale(0.95); }
    to { opacity:1; transform:translateY(0) scale(1); }
  }
  .modal h3 { color:#00d4aa; margin-bottom:16px; font-size:1.1em; }
  .modal .field { margin-bottom:12px; }
  .modal .field label { display:block; color:#aaa; font-size:0.8em; margin-bottom:4px; }
  .modal .btn-row { display:flex; gap:8px; margin-top:16px; }
  .modal .btn-row button { flex:1; }
  .btn-cancel { background:#ffffff15 !important; color:#aaa !important; }
  .btn-add-food {
    background:#00d4aa20; color:#00d4aa; border:1px dashed #00d4aa60;
    padding:8px 16px; border-radius:10px; font-weight:bold; cursor:pointer;
    font-size:0.85em; margin-top:10px; width:100%;
    transition: background 0.2s;
  }
  .btn-add-food:hover { background:#00d4aa35; }

  /* === Custom food items in meal list === */
  .custom-food { position:relative; }
  .custom-food .remove-food {
    color:#ff6b6b; cursor:pointer; font-size:0.75em; margin-left:8px;
    opacity:0.6; transition:opacity 0.2s;
  }
  .custom-food .remove-food:hover { opacity:1; }

  /* === Weekly summary === */
  .summary-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:12px; }
  .summary-stat { text-align:center; background:#0f3460; border-radius:10px; padding:10px 6px; }
  .summary-stat .val { font-size:1.2em; font-weight:bold; color:#00d4aa; }
  .summary-stat .lbl { font-size:0.65em; color:#888; margin-top:2px; }
  .summary-stat.negative .val { color:#ff6b6b; }
  .summary-stat.positive .val { color:#00d4aa; }
  .day-row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid #ffffff08; font-size:0.85em; }
  .day-row:last-child { border:none; }
  .day-row .day-name { color:#aaa; width:80px; }
  .day-row .day-cal { color:#00d4aa; font-weight:bold; }
  .day-row .day-weight { color:#0984e3; }
  .day-row .day-bar { flex:1; margin:0 10px; height:6px; background:#0f3460; border-radius:3px; overflow:hidden; }
  .day-row .day-bar-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,#00d4aa,#00b894); }

  /* === Exercise section === */
  .exercise { padding:8px 0; border-bottom:1px solid #ffffff10; display:flex; justify-content:space-between; align-items:center; }
  .exercise:last-child { border:none; }
  .exercise label { display:flex; align-items:center; gap:8px; cursor:pointer; flex:1; }
  .exercise .ex-cal { color:#888; font-size:0.85em; }
  .exercise.done label { text-decoration:line-through; color:#666; }
  .exercise.done .ex-cal { color:#666; }
  .ex-total { margin-top:10px; text-align:right; font-size:1.1em; }
  .ex-total .burned { color:#00d4aa; font-weight:bold; }
</style>
</head>
<body>
<div class="container">
  <h1>ü•ó Macmimi Diet Tracker</h1>
  <div class="subtitle" id="dateDisplay"></div>

  <!-- PROGRESSION -->
  <div class="card">
    <h2>üìä Progression</h2>
    <div class="stat-grid">
      <div class="stat"><div class="val" id="currentWeight">85.0</div><div class="lbl">Poids actuel (kg)</div></div>
      <div class="stat"><div class="val" id="lostKg">0.0</div><div class="lbl">Perdu (kg)</div></div>
      <div class="stat"><div class="val" id="remainKg">15.0</div><div class="lbl">Reste (kg)</div></div>
      <div class="stat"><div class="val" id="daysLeft">90</div><div class="lbl">Jours restants</div></div>
    </div>
    <div style="margin-top:10px;">
      <div class="row"><span>Objectif 70 kg</span><span class="highlight" id="progressPct">0%</span></div>
      <div class="progress-bg"><div class="progress-fill green" id="progressBar" style="width:0%"></div></div>
    </div>
  </div>

  <!-- PES√âE -->
  <div class="card">
    <h2>‚öñÔ∏è Pes√©e du jour</h2>
    <div style="display:flex;gap:8px;">
      <input type="number" id="weightInput" placeholder="Ex: 84.5" step="0.1" min="50" max="150">
      <button onclick="logWeight()">Log</button>
    </div>
    <canvas id="weightChart"></canvas>
  </div>

  <!-- AUJOURD'HUI -->
  <div class="card">
    <h2>üçΩÔ∏è Repas du jour ‚Äî <span id="dayLabel" class="tag"></span></h2>
    <div class="row" style="margin-bottom:8px;">
      <span>Calories restantes</span>
      <span class="highlight" id="calRemain"></span>
    </div>
    <div class="progress-bg"><div class="progress-fill blue" id="calBar" style="width:0%"></div></div>
    <div class="macro-bar">
      <div class="macro"><div class="val" id="mProt">0g</div><div class="lbl">Prot√©ines</div></div>
      <div class="macro"><div class="val" id="mFat">0g</div><div class="lbl">Lipides</div></div>
      <div class="macro"><div class="val" id="mCarb">0g</div><div class="lbl">Glucides</div></div>
    </div>
    <div id="mealsList" style="margin-top:12px;"></div>
    <button class="btn-add-food" onclick="openAddFoodModal()">+ Ajouter aliment</button>
  </div>

  <!-- EAU -->
  <div class="card">
    <h2>üíß Hydratation</h2>
    <div class="row"><span>Objectif : 8 verres</span><span class="highlight" id="waterCount">0/8</span></div>
    <div class="water-row" id="waterBtns"></div>
  </div>

  <!-- EXERCICE DU JOUR -->
  <div class="card">
    <h2>üèãÔ∏è Exercice du jour</h2>
    <div id="exerciseList"></div>
    <div class="ex-total">Calories br√ªl√©es : <span class="burned" id="exBurned">0</span> cal</div>
  </div>

  <!-- WEEKLY SUMMARY -->
  <div class="card">
    <h2>üìÖ R√©sum√© de la semaine</h2>
    <div class="summary-grid" id="summaryStats"></div>
    <div id="weekDays"></div>
  </div>

</div>

<!-- MODAL: Ajouter aliment -->
<div class="modal-overlay" id="addFoodModal">
  <div class="modal">
    <h3>üç¥ Ajouter un aliment</h3>
    <div class="field">
      <label>Nom de l'aliment</label>
      <input type="text" id="foodName" placeholder="Ex: Yaourt grec">
    </div>
    <div class="field">
      <label>Quantit√© (grammes)</label>
      <input type="number" id="foodGrams" placeholder="Ex: 150" min="1">
    </div>
    <div class="field">
      <label>Calories</label>
      <input type="number" id="foodCalories" placeholder="Ex: 120" min="0">
    </div>
    <div class="btn-row">
      <button class="btn-cancel" onclick="closeAddFoodModal()">Annuler</button>
      <button onclick="addCustomFood()">Ajouter</button>
    </div>
  </div>
</div>

<script>
const MEALS = {
  1: { label:"Jour 1", cal:1614, prot:123, fat:94, carb:53, meals:[
    {name:"üç≥ Petit-d√©j", time:"7h", cal:292, items:["M√ªres 120g ‚Äî 52","√âpinards saut√©s 150g ‚Äî 50","≈íufs brouill√©s 133g ‚Äî 190"]},
    {name:"ü•ú Snack 10h", time:"10h", cal:111, items:["Amandes grill√©es 19g ‚Äî 111"]},
    {name:"ü•ó D√©jeuner", time:"12h30", cal:498, items:["≈íufs durs √ó2 100g ‚Äî 156","Tortilla wrap 60g ‚Äî 180","Poulet grill√© 90g ‚Äî 112","Houmous 30g ‚Äî 50"]},
    {name:"ü•ï Snack 16h", time:"16h", cal:173, items:["Carottes crues 115g ‚Äî 47","Sauce ranch 30g ‚Äî 126"]},
    {name:"üçΩÔ∏è D√Æner", time:"20h", cal:540, items:["L√©gumes vari√©s 40g ‚Äî 24","C√¥telettes de porc 210g ‚Äî 440","Assaisonnement ranch 25g ‚Äî 76"]}
  ]},
  2: { label:"Jour 2", cal:1541, prot:129, fat:68, carb:78, meals:[
    {name:"üç≥ Petit-d√©j", time:"7h", cal:239, items:["Concombre tranch√© 200g ‚Äî 30","Blancs d'≈ìuf 230g ‚Äî 120","√âpinards 80g ‚Äî 18","Huile d'olive 5ml ‚Äî 41"]},
    {name:"ü•ú Snack 10h", time:"10h", cal:80, items:["Shake whey ¬Ω dose 15g ‚Äî 80"]},
    {name:"ü•ó D√©jeuner", time:"12h30", cal:614, items:["≈íuf dur 50g ‚Äî 78","Tortilla wrap 60g ‚Äî 180","Poulet grill√© 80g ‚Äî 100","Mayonnaise 15g ‚Äî 100","Laitue 30g ‚Äî 5","Poivron rouge 40g ‚Äî 10","Canneberges 15g ‚Äî 47","Amandes effil√©es 10g ‚Äî 58"]},
    {name:"üçé Snack 16h", time:"16h", cal:155, items:["Poivron rouge 100g ‚Äî 31","Houmous 40g ‚Äî 77","Myrtilles 75g ‚Äî 47"]},
    {name:"üçΩÔ∏è D√Æner", time:"20h", cal:453, items:["Brocoli r√¥ti 200g ‚Äî 196","Cuisses de poulet 170g ‚Äî 257"]}
  ]},
  3: { label:"Jour 3", cal:1596, prot:143, fat:51, carb:121, meals:[
    {name:"üç≥ Petit-d√©j", time:"7h", cal:217, items:["Flocons d'avoine 45g ‚Äî 170","Eau 200ml ‚Äî 0","Cannelle 3g ‚Äî 7","Miel 10g ‚Äî 40"]},
    {name:"üçå Snack 10h", time:"10h", cal:117, items:["Banane 120g ‚Äî 117"]},
    {name:"ü•ó D√©jeuner", time:"12h30", cal:618, items:["≈íufs durs √ó2 100g ‚Äî 156","Pain complet 2 tr. 60g ‚Äî 150","Dinde en tranches 120g ‚Äî 130","Moutarde 10g ‚Äî 10","Laitue 20g ‚Äî 3"]},
    {name:"üçÆ Snack 16h", time:"16h", cal:213, items:["Power jello cups √ó2 ‚Äî 213"]},
    {name:"üçΩÔ∏è D√Æner", time:"20h", cal:431, items:["Haricots verts 150g ‚Äî 47","Huile d'olive 7ml ‚Äî 61","Poulet √† l'ail 170g ‚Äî 274","L√©gumes vari√©s 80g ‚Äî 49"]}
  ]},
  7: { label:"Jour 7", cal:1591, prot:109, fat:106, carb:33, meals:[
    {name:"üç≥ Petit-d√©j", time:"7h", cal:292, items:["M√ªres 120g ‚Äî 52","√âpinards saut√©s 150g ‚Äî 50","≈íufs brouill√©s 133g ‚Äî 190"]},
    {name:"ü•ú Snack 10h", time:"10h", cal:111, items:["Amandes grill√©es 19g ‚Äî 111"]},
    {name:"ü•ó D√©jeuner", time:"12h30", cal:476, items:["Courgettes 250g ‚Äî 43","Parmesan 20g ‚Äî 80","Huile d'olive 10ml ‚Äî 90","Cabillaud 227g ‚Äî 200","√âpices cajun + huile 5ml ‚Äî 63"]},
    {name:"ü•ï Snack 16h", time:"16h", cal:173, items:["Carottes crues 115g ‚Äî 47","Sauce ranch 30g ‚Äî 126"]},
    {name:"üçΩÔ∏è D√Æner", time:"20h", cal:539, items:["Poivron rouge 100g ‚Äî 26","Oignon rouge 30g ‚Äî 12","Vinaigrette 10ml ‚Äî 32","Steak bavette 189g ‚Äî 469"]}
  ]}
};

const DAY_MAP = {1:1, 2:2, 3:3, 4:1, 5:2, 6:3, 0:7};
const START_DATE = new Date('2026-02-02');
const START_WEIGHT = 85;
const GOAL_WEIGHT = 70;

function today() { return new Date().toISOString().slice(0,10); }
function getCycleDay() { return DAY_MAP[new Date().getDay()]; }
function getDayData() { return MEALS[getCycleDay()]; }
function getStore(k,d) { try{return JSON.parse(localStorage.getItem(k))||d}catch{return d} }
function setStore(k,v) { localStorage.setItem(k,JSON.stringify(v)); }

function init() {
  const d = new Date();
  const days = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
  document.getElementById('dateDisplay').textContent = `${days[d.getDay()]} ${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;

  renderProgress();
  renderMeals();
  renderWater();
  renderExercises();
  renderWeightChart();
  renderWeeklySummary();
}

function renderProgress() {
  const weights = getStore('weights',{});
  const keys = Object.keys(weights).sort();
  const current = keys.length ? weights[keys[keys.length-1]] : START_WEIGHT;
  const lost = START_WEIGHT - current;
  const remain = Math.max(0, current - GOAL_WEIGHT);
  const pct = Math.min(100, (lost / (START_WEIGHT - GOAL_WEIGHT)) * 100);
  const endDate = new Date('2026-05-02');
  const daysLeft = Math.max(0, Math.ceil((endDate - new Date()) / 86400000));

  document.getElementById('currentWeight').textContent = current.toFixed(1);
  document.getElementById('lostKg').textContent = lost.toFixed(1);
  document.getElementById('remainKg').textContent = remain.toFixed(1);
  document.getElementById('daysLeft').textContent = daysLeft;
  document.getElementById('progressPct').textContent = pct.toFixed(0) + '%';
  document.getElementById('progressBar').style.width = pct + '%';
}

function getCustomFoods() {
  return getStore('custom_foods_' + today(), []);
}

function renderMeals() {
  const data = getDayData();
  const dayLabel = document.getElementById('dayLabel');

  const customFoods = getCustomFoods();
  const customCal = customFoods.reduce((sum, f) => sum + f.cal, 0);
  const totalCal = data.cal + customCal;

  dayLabel.textContent = data.label + ' ‚Äî ' + totalCal + ' cal';

  const eaten = getStore('eaten_' + today(), {});
  let calEaten = 0;

  const container = document.getElementById('mealsList');
  container.innerHTML = '';

  data.meals.forEach((meal, i) => {
    if (eaten[i]) calEaten += meal.cal;

    const div = document.createElement('div');
    div.className = 'meal' + (eaten[i] ? ' eaten' : '');
    div.id = 'meal-' + i;
    div.innerHTML = `
      <div class="meal-header" onclick="toggleDetails(${i})">
        <label><input type="checkbox" ${eaten[i]?'checked':''} onchange="toggleMeal(${i},this.checked)" onclick="event.stopPropagation()"> ${meal.name} <span style="color:#888;font-size:0.8em">${meal.time}</span></label>
        <span class="cal">${meal.cal} cal</span>
      </div>
      <div class="meal-details" id="details-${i}">
        ${meal.items.map(it => {
          const parts = it.split(' ‚Äî ');
          return `<li>${parts[0]} ‚Äî <span>${parts[1]} cal</span></li>`;
        }).join('')}
      </div>`;
    container.appendChild(div);
  });

  // Render custom food items
  customFoods.forEach((food, i) => {
    const cKey = 'c' + i;
    if (eaten[cKey]) calEaten += food.cal;

    const div = document.createElement('div');
    div.className = 'meal custom-food' + (eaten[cKey] ? ' eaten' : '');
    div.id = 'meal-c' + i;
    div.innerHTML = `
      <div class="meal-header">
        <label><input type="checkbox" ${eaten[cKey]?'checked':''} onchange="toggleMeal('c${i}',this.checked)" onclick="event.stopPropagation()"> üç¥ ${food.name} <span style="color:#888;font-size:0.8em">${food.grams}g</span></label>
        <span class="cal">${food.cal} cal<span class="remove-food" onclick="removeCustomFood(${i})" title="Supprimer">‚úï</span></span>
      </div>`;
    container.appendChild(div);
  });

  const remain = totalCal - calEaten;
  document.getElementById('calRemain').textContent = remain + ' / ' + totalCal + ' cal';
  document.getElementById('calBar').style.width = ((calEaten/totalCal)*100) + '%';
  document.getElementById('mProt').textContent = data.prot + 'g';
  document.getElementById('mFat').textContent = data.fat + 'g';
  document.getElementById('mCarb').textContent = data.carb + 'g';
}

function toggleMeal(i, checked) {
  const eaten = getStore('eaten_' + today(), {});
  const wasEaten = eaten[i];
  eaten[i] = checked;
  setStore('eaten_' + today(), eaten);

  // Trigger green flash animation on check
  if (checked && !wasEaten) {
    const el = document.getElementById('meal-' + i);
    if (el) {
      el.classList.add('flash-green');
      el.addEventListener('animationend', () => el.classList.remove('flash-green'), { once: true });
    }
  }

  renderMeals();

  // Re-trigger the flash after renderMeals rebuilds the DOM
  if (checked && !wasEaten) {
    requestAnimationFrame(() => {
      const el = document.getElementById('meal-' + i);
      if (el) {
        el.classList.add('flash-green');
        el.addEventListener('animationend', () => el.classList.remove('flash-green'), { once: true });
      }
    });
  }

  // Update weekly summary when meals change
  saveDailyCalories();
  renderWeeklySummary();
}

function toggleDetails(i) {
  document.getElementById('details-' + i).classList.toggle('open');
}

/* === Custom food modal === */
function openAddFoodModal() {
  document.getElementById('addFoodModal').classList.add('open');
  document.getElementById('foodName').value = '';
  document.getElementById('foodGrams').value = '';
  document.getElementById('foodCalories').value = '';
  setTimeout(() => document.getElementById('foodName').focus(), 100);
}

function closeAddFoodModal() {
  document.getElementById('addFoodModal').classList.remove('open');
}

function addCustomFood() {
  const name = document.getElementById('foodName').value.trim();
  const grams = parseInt(document.getElementById('foodGrams').value);
  const cal = parseInt(document.getElementById('foodCalories').value);

  if (!name) { document.getElementById('foodName').focus(); return; }
  if (!grams || grams <= 0) { document.getElementById('foodGrams').focus(); return; }
  if (isNaN(cal) || cal < 0) { document.getElementById('foodCalories').focus(); return; }

  const foods = getCustomFoods();
  foods.push({ name, grams, cal });
  setStore('custom_foods_' + today(), foods);

  closeAddFoodModal();
  renderMeals();
  saveDailyCalories();
  renderWeeklySummary();
}

function removeCustomFood(index) {
  const foods = getCustomFoods();
  foods.splice(index, 1);
  setStore('custom_foods_' + today(), foods);

  // Also clean up eaten state for custom foods
  const eaten = getStore('eaten_' + today(), {});
  const newEaten = {};
  Object.keys(eaten).forEach(k => {
    if (!k.startsWith('c')) {
      newEaten[k] = eaten[k];
    } else {
      const ci = parseInt(k.slice(1));
      if (ci < index) newEaten[k] = eaten[k];
      else if (ci > index) newEaten['c' + (ci - 1)] = eaten[k];
      // skip ci === index (the removed one)
    }
  });
  setStore('eaten_' + today(), newEaten);

  renderMeals();
  saveDailyCalories();
  renderWeeklySummary();
}

// Close modal on overlay click
document.getElementById('addFoodModal').addEventListener('click', function(e) {
  if (e.target === this) closeAddFoodModal();
});

/* === Water === */
function renderWater() {
  const count = getStore('water_' + today(), 0);
  document.getElementById('waterCount').textContent = count + '/8';
  const container = document.getElementById('waterBtns');
  container.innerHTML = '';
  for (let i = 0; i < 8; i++) {
    const btn = document.createElement('button');
    btn.className = 'water-btn' + (i < count ? ' filled' : '');
    btn.textContent = 'üíß';
    btn.onclick = () => {
      setStore('water_' + today(), i < count ? i : i + 1);
      renderWater();
    };
    container.appendChild(btn);
  }
}

/* === Weight === */
function logWeight() {
  const input = document.getElementById('weightInput');
  const val = parseFloat(input.value);
  if (!val || val < 50 || val > 150) return;
  const weights = getStore('weights', {});
  weights[today()] = val;
  setStore('weights', weights);
  input.value = '';
  renderProgress();
  renderWeightChart();
  renderWeeklySummary();
}

function renderWeightChart() {
  const canvas = document.getElementById('weightChart');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * 2;
  canvas.height = 300;
  ctx.scale(2, 2);
  const W = canvas.offsetWidth, H = 150;

  ctx.clearRect(0, 0, W, H);

  const weights = getStore('weights', {});
  const keys = Object.keys(weights).sort();
  if (keys.length === 0) {
    ctx.fillStyle = '#888';
    ctx.font = '12px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('Log ta premi√®re pes√©e ‚¨ÜÔ∏è', W/2, H/2);
    return;
  }

  const vals = keys.map(k => weights[k]);
  const minW = Math.min(GOAL_WEIGHT, ...vals) - 1;
  const maxW = Math.max(START_WEIGHT, ...vals) + 1;
  const padL = 35, padR = 10, padT = 10, padB = 25;
  const chartW = W - padL - padR, chartH = H - padT - padB;

  // Goal line
  const goalY = padT + chartH - ((GOAL_WEIGHT - minW) / (maxW - minW)) * chartH;
  ctx.strokeStyle = '#00d4aa40';
  ctx.setLineDash([4, 4]);
  ctx.beginPath();
  ctx.moveTo(padL, goalY);
  ctx.lineTo(W - padR, goalY);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#00d4aa60';
  ctx.font = '9px system-ui';
  ctx.fillText('70 kg', padL - 3, goalY - 4);

  // Data line
  ctx.strokeStyle = '#0984e3';
  ctx.lineWidth = 2;
  ctx.beginPath();
  vals.forEach((v, i) => {
    const x = padL + (keys.length === 1 ? chartW / 2 : (i / (keys.length - 1)) * chartW);
    const y = padT + chartH - ((v - minW) / (maxW - minW)) * chartH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Dots
  vals.forEach((v, i) => {
    const x = padL + (keys.length === 1 ? chartW / 2 : (i / (keys.length - 1)) * chartW);
    const y = padT + chartH - ((v - minW) / (maxW - minW)) * chartH;
    ctx.fillStyle = '#0984e3';
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#eee';
    ctx.font = '10px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(v.toFixed(1), x, y - 8);
  });

  // X labels
  ctx.fillStyle = '#666';
  ctx.font = '9px system-ui';
  keys.forEach((k, i) => {
    const x = padL + (keys.length === 1 ? chartW / 2 : (i / (keys.length - 1)) * chartW);
    ctx.fillText(k.slice(5), x, H - 5);
  });
}

/* === Exercise === */
const EXERCISES = [
  { id:'walk', name:'üö∂ 30 min marche (treadmill)', cal:150 },
  { id:'meditate', name:'üßò 20 min m√©ditation', cal:30 }
];

function renderExercises() {
  const done = getStore('exercise_' + today(), {});
  const container = document.getElementById('exerciseList');
  container.innerHTML = '';
  let totalBurned = 0;

  EXERCISES.forEach(ex => {
    if (done[ex.id]) totalBurned += ex.cal;
    const div = document.createElement('div');
    div.className = 'exercise' + (done[ex.id] ? ' done' : '');
    div.innerHTML = `
      <label><input type="checkbox" ${done[ex.id]?'checked':''} onchange="toggleExercise('${ex.id}',this.checked)"> ${ex.name}</label>
      <span class="ex-cal">~${ex.cal} cal</span>`;
    container.appendChild(div);
  });

  document.getElementById('exBurned').textContent = totalBurned;
}

function toggleExercise(id, checked) {
  const done = getStore('exercise_' + today(), {});
  done[id] = checked;
  setStore('exercise_' + today(), done);
  renderExercises();
}

/* === Weekly Summary === */
function saveDailyCalories() {
  const data = getDayData();
  const eaten = getStore('eaten_' + today(), {});
  const customFoods = getCustomFoods();
  let calEaten = 0;

  data.meals.forEach((meal, i) => {
    if (eaten[i]) calEaten += meal.cal;
  });
  customFoods.forEach((food, i) => {
    if (eaten['c' + i]) calEaten += food.cal;
  });

  const dailyCals = getStore('daily_calories', {});
  dailyCals[today()] = calEaten;
  setStore('daily_calories', dailyCals);
}

function getWeekDates() {
  const now = new Date();
  const dayOfWeek = now.getDay(); // 0=Sun
  const monday = new Date(now);
  monday.setDate(now.getDate() - ((dayOfWeek + 6) % 7)); // go back to Monday

  const dates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    dates.push(d.toISOString().slice(0, 10));
  }
  return dates;
}

function renderWeeklySummary() {
  const weekDates = getWeekDates();
  const dailyCals = getStore('daily_calories', {});
  const weights = getStore('weights', {});
  const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

  // Compute stats
  const weekCals = weekDates.map(d => dailyCals[d] || 0);
  const daysWithData = weekCals.filter(c => c > 0);
  const avgCal = daysWithData.length ? Math.round(daysWithData.reduce((a, b) => a + b, 0) / daysWithData.length) : 0;
  const totalCal = weekCals.reduce((a, b) => a + b, 0);

  // Weight trend for the week
  const weekWeights = weekDates.map(d => weights[d]).filter(w => w !== undefined);
  let weightTrend = 0;
  let trendLabel = '‚Äî';
  let trendClass = '';
  if (weekWeights.length >= 2) {
    weightTrend = weekWeights[weekWeights.length - 1] - weekWeights[0];
    trendLabel = (weightTrend > 0 ? '+' : '') + weightTrend.toFixed(1) + ' kg';
    trendClass = weightTrend <= 0 ? 'positive' : 'negative';
  } else if (weekWeights.length === 1) {
    trendLabel = weekWeights[0].toFixed(1) + ' kg';
  }

  // Render summary stats
  const statsEl = document.getElementById('summaryStats');
  statsEl.innerHTML = `
    <div class="summary-stat">
      <div class="val">${avgCal || '‚Äî'}</div>
      <div class="lbl">Moy. cal/jour</div>
    </div>
    <div class="summary-stat">
      <div class="val">${totalCal}</div>
      <div class="lbl">Total cal</div>
    </div>
    <div class="summary-stat ${trendClass}">
      <div class="val">${trendLabel}</div>
      <div class="lbl">Tendance poids</div>
    </div>
  `;

  // Render day-by-day breakdown
  const maxCal = Math.max(2000, ...weekCals);
  const daysEl = document.getElementById('weekDays');
  daysEl.innerHTML = '';

  weekDates.forEach((date, i) => {
    const cal = dailyCals[date] || 0;
    const w = weights[date];
    const isToday = date === today();

    const row = document.createElement('div');
    row.className = 'day-row';
    row.style.opacity = isToday ? '1' : (cal > 0 || w ? '0.9' : '0.4');
    row.innerHTML = `
      <span class="day-name">${dayNames[i]}${isToday ? ' *' : ''}</span>
      <span class="day-cal">${cal > 0 ? cal + ' cal' : '‚Äî'}</span>
      <div class="day-bar"><div class="day-bar-fill" style="width:${cal > 0 ? (cal/maxCal)*100 : 0}%"></div></div>
      <span class="day-weight">${w ? w.toFixed(1) + ' kg' : '‚Äî'}</span>
    `;
    daysEl.appendChild(row);
  });
}

init();
</script>
</body>
</html>
